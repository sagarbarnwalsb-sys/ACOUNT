<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Stock Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Previous CSS styles remain the same, adding only new styles for the new modules */
        
        .bg-supplier {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
        }
        
        .bg-return {
            background: linear-gradient(45deg, #ab47bc, #7e57c2);
            color: white;
        }
        
        .bg-ledger {
            background: linear-gradient(45deg, #26a69a, #26c6da);
            color: white;
        }
        
        .bg-report {
            background: linear-gradient(45deg, #5c6bc0, #42a5f5);
            color: white;
        }
        
        .sale-item-row, .purchase-item-row {
            border-bottom: 1px solid #dee2e6;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .item-actions {
            display: flex;
            gap: 5px;
        }
        
        .total-section {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-card {
            transition: all 0.3s;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- All previous modals and structure remain the same -->

    <!-- Add Supplier Modal -->
    <div class="modal fade" id="addSupplierModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">Add New Supplier</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addSupplierForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Supplier Name *</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Contact Person</label>
                                    <input type="text" class="form-control" name="contact_person">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" name="phone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <textarea class="form-control" name="address" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Opening Balance (रू)</label>
                                    <input type="number" step="0.01" class="form-control" name="opening_balance" value="0">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="save-supplier-btn">Add Supplier</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Sale Modal -->
    <div class="modal fade" id="newSaleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-shopping-cart me-2"></i>New Sale
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Customer</label>
                                <select class="form-select" id="sale-customer">
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sale Date</label>
                                <input type="date" class="form-control" id="sale-date" value="<?php echo date('Y-m-d'); ?>">
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Add Items</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <select class="form-select" id="sale-product">
                                        <option value="">Select Medicine</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="sale-quantity" placeholder="Qty" min="1">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="sale-price" placeholder="Price" step="0.01">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" id="add-sale-item-btn">
                                        <i class="fas fa-plus me-2"></i>Add Item
                                    </button>
                                </div>
                            </div>
                            
                            <div id="sale-items-list">
                                <!-- Sale items will be added here -->
                            </div>
                            
                            <div class="total-section">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <strong>Subtotal: </strong><span id="sale-subtotal">रू 0.00</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Tax (13%): </strong><span id="sale-tax">रू 0.00</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Discount: </strong>
                                            <input type="number" class="form-control d-inline-block w-50" id="sale-discount" value="0" step="0.01">
                                        </div>
                                        <div class="mb-2">
                                            <strong>Grand Total: </strong><span id="sale-grand-total">रू 0.00</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Payment Method</label>
                                            <select class="form-select" id="sale-payment-method">
                                                <option value="cash">Cash</option>
                                                <option value="card">Card</option>
                                                <option value="credit">Credit</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Amount Paid</label>
                                            <input type="number" class="form-control" id="sale-paid-amount" value="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="save-sale-btn">
                        <i class="fas fa-save me-2"></i>Complete Sale
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Purchase Modal -->
    <div class="modal fade" id="newPurchaseModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-boxes me-2"></i>New Purchase
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Supplier</label>
                                <select class="form-select" id="purchase-supplier">
                                    <option value="">Select Supplier</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Purchase Date</label>
                                <input type="date" class="form-control" id="purchase-date" value="<?php echo date('Y-m-d'); ?>">
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Add Items</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <select class="form-select" id="purchase-product">
                                        <option value="">Select Medicine</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="purchase-quantity" placeholder="Qty" min="1">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="purchase-price" placeholder="Cost Price" step="0.01">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-success w-100" id="add-purchase-item-btn">
                                        <i class="fas fa-plus me-2"></i>Add Item
                                    </button>
                                </div>
                            </div>
                            
                            <div id="purchase-items-list">
                                <!-- Purchase items will be added here -->
                            </div>
                            
                            <div class="total-section">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <strong>Subtotal: </strong><span id="purchase-subtotal">रू 0.00</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Tax (13%): </strong><span id="purchase-tax">रू 0.00</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Grand Total: </strong><span id="purchase-grand-total">रू 0.00</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Payment Status</label>
                                            <select class="form-select" id="purchase-payment-status">
                                                <option value="paid">Paid</option>
                                                <option value="credit">Credit</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="save-purchase-btn">
                        <i class="fas fa-save me-2"></i>Complete Purchase
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0">
                <!-- Previous sidebar content remains the same -->
            </div>

            <!-- Main Content -->
            <div class="col-md-10 main-content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="module-section active">
                    <!-- Previous dashboard content remains the same -->
                </div>

                <!-- Medicines Section -->
                <div id="medicines" class="module-section">
                    <!-- Previous medicines content remains the same -->
                </div>

                <!-- Customers Section -->
                <div id="customers" class="module-section">
                    <!-- Previous customers content remains the same -->
                </div>

                <!-- Suppliers Section -->
                <div id="suppliers" class="module-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="fas fa-truck me-2"></i>Supplier Management</h3>
                        <div>
                            <input type="text" class="form-control search-box d-inline-block me-2" id="supplier-search" placeholder="Search suppliers...">
                            <button class="btn btn-warning" id="add-supplier-btn">
                                <i class="fas fa-plus me-2"></i>Add New Supplier
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Supplier List</h5>
                            <span class="badge bg-light text-dark" id="supplier-count">0 suppliers</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Contact Person</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Address</th>
                                            <th>Balance (रू)</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="suppliers-table-body">
                                        <!-- Suppliers data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales Section -->
                <div id="sales" class="module-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="fas fa-shopping-cart me-2"></i>Sales Management</h3>
                        <div>
                            <input type="text" class="form-control search-box d-inline-block me-2" id="sale-search" placeholder="Search sales...">
                            <button class="btn btn-primary" id="new-sale-btn">
                                <i class="fas fa-plus me-2"></i>New Sale
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Sales History</h5>
                            <span class="badge bg-light text-dark" id="sale-count">0 sales</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Sale ID</th>
                                            <th>Customer</th>
                                            <th>Date</th>
                                            <th>Items</th>
                                            <th>Total Amount</th>
                                            <th>Payment Method</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sales-table-body">
                                        <!-- Sales data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchases Section -->
                <div id="purchases" class="module-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="fas fa-boxes me-2"></i>Purchase Management</h3>
                        <div>
                            <input type="text" class="form-control search-box d-inline-block me-2" id="purchase-search" placeholder="Search purchases...">
                            <button class="btn btn-success" id="new-purchase-btn">
                                <i class="fas fa-plus me-2"></i>New Purchase
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Purchase History</h5>
                            <span class="badge bg-light text-dark" id="purchase-count">0 purchases</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Purchase ID</th>
                                            <th>Supplier</th>
                                            <th>Date</th>
                                            <th>Items</th>
                                            <th>Total Amount</th>
                                            <th>Payment Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchases-table-body">
                                        <!-- Purchases data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Returns Section -->
                <div id="returns" class="module-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="fas fa-undo me-2"></i>Returns Management</h3>
                        <div>
                            <input type="text" class="form-control search-box d-inline-block me-2" id="return-search" placeholder="Search returns...">
                            <button class="btn btn-info" id="new-return-btn">
                                <i class="fas fa-plus me-2"></i>Process Return
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Returns History</h5>
                            <span class="badge bg-light text-dark" id="return-count">0 returns</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Return ID</th>
                                            <th>Type</th>
                                            <th>Reference</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Reason</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="returns-table-body">
                                        <!-- Returns data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ledgers Section -->
                <div id="ledgers" class="module-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="fas fa-book me-2"></i>Ledger Management</h3>
                        <div>
                            <input type="text" class="form-control search-box d-inline-block me-2" id="ledger-search" placeholder="Search ledger...">
                            <button class="btn btn-secondary" id="view-ledger-btn">
                                <i class="fas fa-eye me-2"></i>View Ledger
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">Customer Ledger</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Customer</th>
                                                    <th>Balance</th>
                                                </tr>
                                            </thead>
                                            <tbody id="customer-ledger-body">
                                                <!-- Customer ledger will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-warning text-white">
                                    <h6 class="mb-0">Supplier Ledger</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Supplier</th>
                                                    <th>Balance</th>
                                                </tr>
                                            </thead>
                                            <tbody id="supplier-ledger-body">
                                                <!-- Supplier ledger will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports" class="module-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="fas fa-chart-bar me-2"></i>Reports & Analytics</h3>
                        <div>
                            <button class="btn btn-primary me-2" id="generate-sales-report">
                                <i class="fas fa-download me-2"></i>Sales Report
                            </button>
                            <button class="btn btn-success" id="generate-stock-report">
                                <i class="fas fa-download me-2"></i>Stock Report
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="card report-card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 id="total-sales-amount">रू 0.00</h4>
                                    <p>Total Sales</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card report-card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 id="total-purchase-amount">रू 0.00</h4>
                                    <p>Total Purchases</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card report-card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 id="total-profit-amount">रू 0.00</h4>
                                    <p>Total Profit</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card report-card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 id="total-customer-balance">रू 0.00</h4>
                                    <p>Customer Balance</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h6>Sales vs Purchases (Last 7 Days)</h6>
                                <canvas id="salesPurchaseChart" height="200"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h6>Stock Status</h6>
                                <canvas id="stockChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">Recent Transactions</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-transactions-body">
                                        <!-- Recent transactions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Receipts and Payments sections remain the same -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Enhanced data storage with all modules
        let medicines = JSON.parse(localStorage.getItem('medicines')) || [];
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        let returns = JSON.parse(localStorage.getItem('returns')) || [];
        let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];

        // Initialize data for new modules
        function initializeAllData() {
            // Initialize suppliers if empty
            if (suppliers.length === 0) {
                suppliers = [
                    {
                        id: 1,
                        name: "Medi Supplies Ltd",
                        contact_person: "Raj Sharma",
                        phone: "9876543210",
                        email: "supply@medisupplies.com",
                        address: "456 Supplier Ave, Industrial Area",
                        balance: 0
                    },
                    {
                        id: 2,
                        name: "Pharma Distributors",
                        contact_person: "Priya Patel",
                        phone: "8765432109",
                        email: "orders@pharmadist.com",
                        address: "789 Distribution Road",
                        balance: 1500.75
                    }
                ];
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
            }

            // Initialize sales if empty
            if (sales.length === 0) {
                sales = [
                    {
                        id: 1,
                        customer_id: 1,
                        customer_name: "John Doe",
                        date: new Date().toISOString().split('T')[0],
                        items: [
                            { medicine_id: 1, name: "Paracetamol 500mg", quantity: 2, price: 35.50, total: 71.00 },
                            { medicine_id: 2, name: "Amoxicillin 250mg", quantity: 1, price: 60.00, total: 60.00 }
                        ],
                        subtotal: 131.00,
                        tax: 17.03,
                        discount: 0,
                        grand_total: 148.03,
                        payment_method: "cash",
                        paid_amount: 148.03,
                        balance: 0,
                        status: "completed"
                    }
                ];
                localStorage.setItem('sales', JSON.stringify(sales));
            }

            // Initialize purchases if empty
            if (purchases.length === 0) {
                purchases = [
                    {
                        id: 1,
                        supplier_id: 1,
                        supplier_name: "Medi Supplies Ltd",
                        date: new Date().toISOString().split('T')[0],
                        items: [
                            { medicine_id: 1, name: "Paracetamol 500mg", quantity: 100, price: 25.50, total: 2550.00 },
                            { medicine_id: 2, name: "Amoxicillin 250mg", quantity: 50, price: 45.75, total: 2287.50 }
                        ],
                        subtotal: 4837.50,
                        tax: 628.88,
                        grand_total: 5466.38,
                        payment_status: "paid",
                        status: "completed"
                    }
                ];
                localStorage.setItem('purchases', JSON.stringify(purchases));
            }

            // Initialize returns if empty
            if (returns.length === 0) {
                returns = [
                    {
                        id: 1,
                        type: "sale_return",
                        reference_id: 1,
                        reference_number: "SALE-001",
                        date: new Date().toISOString().split('T')[0],
                        items: [
                            { medicine_id: 1, name: "Paracetamol 500mg", quantity: 1, price: 35.50, total: 35.50 }
                        ],
                        total_amount: 35.50,
                        reason: "Customer changed mind",
                        status: "completed"
                    }
                ];
                localStorage.setItem('returns', JSON.stringify(returns));
            }
        }

        // Setup event listeners for new modules
        function setupAllEventListeners() {
            // Previous event listeners remain...

            // Supplier buttons
            document.getElementById('add-supplier-btn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addSupplierModal'));
                modal.show();
            });
            
            document.getElementById('save-supplier-btn').addEventListener('click', addSupplier);

            // Sale buttons
            document.getElementById('new-sale-btn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('newSaleModal'));
                loadSaleFormData();
                modal.show();
            });

            document.getElementById('add-sale-item-btn').addEventListener('click', addSaleItem);
            document.getElementById('save-sale-btn').addEventListener('click', saveSale);

            // Purchase buttons
            document.getElementById('new-purchase-btn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('newPurchaseModal'));
                loadPurchaseFormData();
                modal.show();
            });

            document.getElementById('add-purchase-item-btn').addEventListener('click', addPurchaseItem);
            document.getElementById('save-purchase-btn').addEventListener('click', savePurchase);

            // Return buttons
            document.getElementById('new-return-btn').addEventListener('click', processReturn);

            // Ledger buttons
            document.getElementById('view-ledger-btn').addEventListener('click', viewLedger);

            // Report buttons
            document.getElementById('generate-sales-report').addEventListener('click', generateSalesReport);
            document.getElementById('generate-stock-report').addEventListener('click', generateStockReport);

            // Search functionality for new modules
            document.getElementById('supplier-search').addEventListener('input', loadSuppliersData);
            document.getElementById('sale-search').addEventListener('input', loadSalesData);
            document.getElementById('purchase-search').addEventListener('input', loadPurchasesData);
            document.getElementById('return-search').addEventListener('input', loadReturnsData);
            document.getElementById('ledger-search').addEventListener('input', loadLedgerData);
        }

        // Supplier Management Functions
        function addSupplier() {
            const form = document.getElementById('addSupplierForm');
            const formData = new FormData(form);
            
            if (!formData.get('name')) {
                showToast('Please fill in the supplier name', 'warning');
                return;
            }
            
            const supplier = {
                id: suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1,
                name: formData.get('name'),
                contact_person: formData.get('contact_person'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: formData.get('address'),
                balance: parseFloat(formData.get('opening_balance')) || 0
            };
            
            suppliers.push(supplier);
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            
            bootstrap.Modal.getInstance(document.getElementById('addSupplierModal')).hide();
            form.reset();
            
            loadSuppliersData();
            showToast('Supplier added successfully!', 'success');
        }

        function loadSuppliersData() {
            const tbody = document.getElementById('suppliers-table-body');
            const searchTerm = document.getElementById('supplier-search').value.toLowerCase();
            document.getElementById('supplier-count').textContent = `${suppliers.length} suppliers`;
            
            let filteredSuppliers = suppliers;
            
            if (searchTerm) {
                filteredSuppliers = suppliers.filter(supplier => 
                    supplier.name.toLowerCase().includes(searchTerm) ||
                    (supplier.contact_person && supplier.contact_person.toLowerCase().includes(searchTerm)) ||
                    (supplier.phone && supplier.phone.includes(searchTerm))
                );
            }
            
            tbody.innerHTML = filteredSuppliers.map(supplier => {
                const balanceClass = supplier.balance > 0 ? 'text-danger' : (supplier.balance < 0 ? 'text-success' : '');
                const balanceText = supplier.balance > 0 ? `+${formatCurrency(supplier.balance)}` : formatCurrency(supplier.balance);
                
                return `
                    <tr>
                        <td>${supplier.id}</td>
                        <td>${supplier.name}</td>
                        <td>${supplier.contact_person || '-'}</td>
                        <td>${supplier.phone || '-'}</td>
                        <td>${supplier.email || '-'}</td>
                        <td>${supplier.address ? supplier.address.substring(0, 30) + (supplier.address.length > 30 ? '...' : '') : '-'}</td>
                        <td class="${balanceClass}">${balanceText}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="viewSupplier(${supplier.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editSupplier(${supplier.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSupplier(${supplier.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (supplier) {
                showToast(`Viewing supplier: ${supplier.name}`, 'info');
            }
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (supplier) {
                showToast(`Edit functionality for "${supplier.name}" would open here`, 'info');
            }
        }

        function deleteSupplier(id) {
            if (confirm('Are you sure you want to delete this supplier?')) {
                suppliers = suppliers.filter(s => s.id !== id);
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                loadSuppliersData();
                showToast('Supplier deleted successfully!', 'success');
            }
        }

        // Sales Management Functions
        function loadSaleFormData() {
            // Load customers for dropdown
            const customerSelect = document.getElementById('sale-customer');
            customerSelect.innerHTML = '<option value="">Select Customer</option>' +
                customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            // Load medicines for dropdown
            const productSelect = document.getElementById('sale-product');
            productSelect.innerHTML = '<option value="">Select Medicine</option>' +
                medicines.map(m => `<option value="${m.id}" data-price="${m.selling_price}">${m.name} - Stock: ${m.stock_quantity}</option>`).join('');
            
            // Clear existing items
            document.getElementById('sale-items-list').innerHTML = '';
            updateSaleTotals();
        }

        function addSaleItem() {
            const productSelect = document.getElementById('sale-product');
            const quantityInput = document.getElementById('sale-quantity');
            const priceInput = document.getElementById('sale-price');
            
            const productId = parseInt(productSelect.value);
            const quantity = parseInt(quantityInput.value);
            const price = parseFloat(priceInput.value);
            
            if (!productId || !quantity || !price) {
                showToast('Please select product and enter quantity and price', 'warning');
                return;
            }
            
            const product = medicines.find(m => m.id === productId);
            if (!product) {
                showToast('Product not found', 'error');
                return;
            }
            
            if (quantity > product.stock_quantity) {
                showToast(`Insufficient stock. Available: ${product.stock_quantity}`, 'warning');
                return;
            }
            
            const total = quantity * price;
            const itemId = Date.now();
            
            const itemHTML = `
                <div class="sale-item-row" data-item-id="${itemId}" data-product-id="${productId}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <strong>${product.name}</strong>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control form-control-sm" value="${quantity}" min="1" onchange="updateSaleItemQuantity(${itemId}, this.value)">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control form-control-sm" value="${price.toFixed(2)}" step="0.01" onchange="updateSaleItemPrice(${itemId}, this.value)">
                        </div>
                        <div class="col-md-2">
                            <strong>${formatCurrency(total)}</strong>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-sm btn-danger" onclick="removeSaleItem(${itemId})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('sale-items-list').insertAdjacentHTML('beforeend', itemHTML);
            
            // Clear inputs
            quantityInput.value = '';
            priceInput.value = '';
            productSelect.value = '';
            
            updateSaleTotals();
        }

        function updateSaleTotals() {
            let subtotal = 0;
            const items = document.querySelectorAll('#sale-items-list .sale-item-row');
            
            items.forEach(item => {
                const quantity = parseInt(item.querySelector('input[type="number"]:first-child').value);
                const price = parseFloat(item.querySelector('input[type="number"]:last-child').value);
                subtotal += quantity * price;
            });
            
            const tax = subtotal * 0.13;
            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            const grandTotal = subtotal + tax - discount;
            
            document.getElementById('sale-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('sale-tax').textContent = formatCurrency(tax);
            document.getElementById('sale-grand-total').textContent = formatCurrency(grandTotal);
            
            // Auto-fill paid amount for cash payments
            const paymentMethod = document.getElementById('sale-payment-method').value;
            if (paymentMethod === 'cash') {
                document.getElementById('sale-paid-amount').value = grandTotal.toFixed(2);
            }
        }

        function saveSale() {
            const customerId = parseInt(document.getElementById('sale-customer').value);
            const date = document.getElementById('sale-date').value;
            const paymentMethod = document.getElementById('sale-payment-method').value;
            const paidAmount = parseFloat(document.getElementById('sale-paid-amount').value);
            const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
            
            if (!customerId) {
                showToast('Please select a customer', 'warning');
                return;
            }
            
            const items = [];
            const itemElements = document.querySelectorAll('#sale-items-list .sale-item-row');
            
            if (itemElements.length === 0) {
                showToast('Please add at least one item', 'warning');
                return;
            }
            
            itemElements.forEach(item => {
                const productId = parseInt(item.getAttribute('data-product-id'));
                const quantity = parseInt(item.querySelector('input[type="number"]:first-child').value);
                const price = parseFloat(item.querySelector('input[type="number"]:last-child').value);
                
                items.push({
                    medicine_id: productId,
                    name: medicines.find(m => m.id === productId)?.name || 'Unknown',
                    quantity: quantity,
                    price: price,
                    total: quantity * price
                });
            });
            
            const subtotal = items.reduce((sum, item) => sum + item.total, 0);
            const tax = subtotal * 0.13;
            const grandTotal = subtotal + tax - discount;
            const balance = grandTotal - paidAmount;
            
            const sale = {
                id: sales.length > 0 ? Math.max(...sales.map(s => s.id)) + 1 : 1,
                customer_id: customerId,
                customer_name: customers.find(c => c.id === customerId)?.name || 'Unknown',
                date: date,
                items: items,
                subtotal: subtotal,
                tax: tax,
                discount: discount,
                grand_total: grandTotal,
                payment_method: paymentMethod,
                paid_amount: paidAmount,
                balance: balance,
                status: balance === 0 ? 'completed' : 'pending'
            };
            
            sales.push(sale);
            localStorage.setItem('sales', JSON.stringify(sales));
            
            // Update medicine stock
            items.forEach(item => {
                const medicine = medicines.find(m => m.id === item.medicine_id);
                if (medicine) {
                    medicine.stock_quantity -= item.quantity;
                }
            });
            localStorage.setItem('medicines', JSON.stringify(medicines));
            
            // Update customer balance if credit
            if (paymentMethod === 'credit') {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.balance += balance;
                    localStorage.setItem('customers', JSON.stringify(customers));
                }
            }
            
            bootstrap.Modal.getInstance(document.getElementById('newSaleModal')).hide();
            loadSalesData();
            loadDashboardData();
            showToast('Sale completed successfully!', 'success');
        }

        function loadSalesData() {
            const tbody = document.getElementById('sales-table-body');
            const searchTerm = document.getElementById('sale-search').value.toLowerCase();
            document.getElementById('sale-count').textContent = `${sales.length} sales`;
            
            let filteredSales = sales;
            
            if (searchTerm) {
                filteredSales = sales.filter(sale => 
                    sale.customer_name.toLowerCase().includes(searchTerm) ||
                    sale.id.toString().includes(searchTerm)
                );
            }
            
            tbody.innerHTML = filteredSales.map(sale => {
                const statusClass = sale.status === 'completed' ? 'status-paid' : 'status-pending';
                const statusText = sale.status === 'completed' ? 'Completed' : 'Pending';
                
                return `
                    <tr>
                        <td>#${sale.id}</td>
                        <td>${sale.customer_name}</td>
                        <td>${new Date(sale.date).toLocaleDateString()}</td>
                        <td>${sale.items.length} items</td>
                        <td>${formatCurrency(sale.grand_total)}</td>
                        <td>${sale.payment_method}</td>
                        <td><span class="payment-status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="viewSale(${sale.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editSale(${sale.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Purchase Management Functions (similar pattern to sales)
        function loadPurchaseFormData() {
            // Load suppliers for dropdown
            const supplierSelect = document.getElementById('purchase-supplier');
            supplierSelect.innerHTML = '<option value="">Select Supplier</option>' +
                suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            // Load medicines for dropdown
            const productSelect = document.getElementById('purchase-product');
            productSelect.innerHTML = '<option value="">Select Medicine</option>' +
                medicines.map(m => `<option value="${m.id}" data-price="${m.cost_price}">${m.name}</option>`).join('');
            
            // Clear existing items
            document.getElementById('purchase-items-list').innerHTML = '';
            updatePurchaseTotals();
        }

        function addPurchaseItem() {
            const productSelect = document.getElementById('purchase-product');
            const quantityInput = document.getElementById('purchase-quantity');
            const priceInput = document.getElementById('purchase-price');
            
            const productId = parseInt(productSelect.value);
            const quantity = parseInt(quantityInput.value);
            const price = parseFloat(priceInput.value);
            
            if (!productId || !quantity || !price) {
                showToast('Please select product and enter quantity and price', 'warning');
                return;
            }
            
            const product = medicines.find(m => m.id === productId);
            if (!product) {
                showToast('Product not found', 'error');
                return;
            }
            
            const total = quantity * price;
            const itemId = Date.now();
            
            const itemHTML = `
                <div class="purchase-item-row" data-item-id="${itemId}" data-product-id="${productId}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <strong>${product.name}</strong>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control form-control-sm" value="${quantity}" min="1" onchange="updatePurchaseItemQuantity(${itemId}, this.value)">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control form-control-sm" value="${price.toFixed(2)}" step="0.01" onchange="updatePurchaseItemPrice(${itemId}, this.value)">
                        </div>
                        <div class="col-md-2">
                            <strong>${formatCurrency(total)}</strong>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-sm btn-danger" onclick="removePurchaseItem(${itemId})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('purchase-items-list').insertAdjacentHTML('beforeend', itemHTML);
            
            // Clear inputs
            quantityInput.value = '';
            priceInput.value = '';
            productSelect.value = '';
            
            updatePurchaseTotals();
        }

        function updatePurchaseTotals() {
            let subtotal = 0;
            const items = document.querySelectorAll('#purchase-items-list .purchase-item-row');
            
            items.forEach(item => {
                const quantity = parseInt(item.querySelector('input[type="number"]:first-child').value);
                const price = parseFloat(item.querySelector('input[type="number"]:last-child').value);
                subtotal += quantity * price;
            });
            
            const tax = subtotal * 0.13;
            const grandTotal = subtotal + tax;
            
            document.getElementById('purchase-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('purchase-tax').textContent = formatCurrency(tax);
            document.getElementById('purchase-grand-total').textContent = formatCurrency(grandTotal);
        }

        function savePurchase() {
            const supplierId = parseInt(document.getElementById('purchase-supplier').value);
            const date = document.getElementById('purchase-date').value;
            const paymentStatus = document.getElementById('purchase-payment-status').value;
            
            if (!supplierId) {
                showToast('Please select a supplier', 'warning');
                return;
            }
            
            const items = [];
            const itemElements = document.querySelectorAll('#purchase-items-list .purchase-item-row');
            
            if (itemElements.length === 0) {
                showToast('Please add at least one item', 'warning');
                return;
            }
            
            itemElements.forEach(item => {
                const productId = parseInt(item.getAttribute('data-product-id'));
                const quantity = parseInt(item.querySelector('input[type="number"]:first-child').value);
                const price = parseFloat(item.querySelector('input[type="number"]:last-child').value);
                
                items.push({
                    medicine_id: productId,
                    name: medicines.find(m => m.id === productId)?.name || 'Unknown',
                    quantity: quantity,
                    price: price,
                    total: quantity * price
                });
            });
            
            const subtotal = items.reduce((sum, item) => sum + item.total, 0);
            const tax = subtotal * 0.13;
            const grandTotal = subtotal + tax;
            
            const purchase = {
                id: purchases.length > 0 ? Math.max(...purchases.map(p => p.id)) + 1 : 1,
                supplier_id: supplierId,
                supplier_name: suppliers.find(s => s.id === supplierId)?.name || 'Unknown',
                date: date,
                items: items,
                subtotal: subtotal,
                tax: tax,
                grand_total: grandTotal,
                payment_status: paymentStatus,
                status: 'completed'
            };
            
            purchases.push(purchase);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            
            // Update medicine stock and cost price
            items.forEach(item => {
                const medicine = medicines.find(m => m.id === item.medicine_id);
                if (medicine) {
                    medicine.stock_quantity += item.quantity;
                    // Update cost price to the latest purchase price
                    medicine.cost_price = item.price;
                }
            });
            localStorage.setItem('medicines', JSON.stringify(medicines));
            
            // Update supplier balance if credit
            if (paymentStatus === 'credit') {
                const supplier = suppliers.find(s => s.id === supplierId);
                if (supplier) {
                    supplier.balance += grandTotal;
                    localStorage.setItem('suppliers', JSON.stringify(suppliers));
                }
            }
            
            bootstrap.Modal.getInstance(document.getElementById('newPurchaseModal')).hide();
            loadPurchasesData();
            loadDashboardData();
            showToast('Purchase completed successfully!', 'success');
        }

        function loadPurchasesData() {
            const tbody = document.getElementById('purchases-table-body');
            const searchTerm = document.getElementById('purchase-search').value.toLowerCase();
            document.getElementById('purchase-count').textContent = `${purchases.length} purchases`;
            
            let filteredPurchases = purchases;
            
            if (searchTerm) {
                filteredPurchases = purchases.filter(purchase => 
                    purchase.supplier_name.toLowerCase().includes(searchTerm) ||
                    purchase.id.toString().includes(searchTerm)
                );
            }
            
            tbody.innerHTML = filteredPurchases.map(purchase => {
                const statusClass = purchase.payment_status === 'paid' ? 'status-paid' : 'status-pending';
                const statusText = purchase.payment_status === 'paid' ? 'Paid' : 'Credit';
                
                return `
                    <tr>
                        <td>#${purchase.id}</td>
                        <td>${purchase.supplier_name}</td>
                        <td>${new Date(purchase.date).toLocaleDateString()}</td>
                        <td>${purchase.items.length} items</td>
                        <td>${formatCurrency(purchase.grand_total)}</td>
                        <td><span class="payment-status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="viewPurchase(${purchase.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editPurchase(${purchase.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Returns Management Functions
        function processReturn() {
            showToast('Return processing functionality would open here', 'info');
        }

        function loadReturnsData() {
            const tbody = document.getElementById('returns-table-body');
            const searchTerm = document.getElementById('return-search').value.toLowerCase();
            document.getElementById('return-count').textContent = `${returns.length} returns`;
            
            let filteredReturns = returns;
            
            if (searchTerm) {
                filteredReturns = returns.filter(returnItem => 
                    returnItem.reference_number.toLowerCase().includes(searchTerm) ||
                    returnItem.type.toLowerCase().includes(searchTerm)
                );
            }
            
            tbody.innerHTML = filteredReturns.map(returnItem => {
                const statusClass = returnItem.status === 'completed' ? 'status-paid' : 'status-pending';
                
                return `
                    <tr>
                        <td>#${returnItem.id}</td>
                        <td>${returnItem.type.replace('_', ' ').toUpperCase()}</td>
                        <td>${returnItem.reference_number}</td>
                        <td>${new Date(returnItem.date).toLocaleDateString()}</td>
                        <td>${formatCurrency(returnItem.total_amount)}</td>
                        <td>${returnItem.reason}</td>
                        <td><span class="payment-status-badge ${statusClass}">${returnItem.status}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="viewReturn(${returnItem.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ledger Management Functions
        function viewLedger() {
            showToast('Ledger view functionality would open here', 'info');
        }

        function loadLedgerData() {
            // Load customer ledger
            const customerLedgerBody = document.getElementById('customer-ledger-body');
            customerLedgerBody.innerHTML = customers.map(customer => `
                <tr>
                    <td>${customer.name}</td>
                    <td class="${customer.balance > 0 ? 'text-danger' : 'text-success'}">
                        ${customer.balance > 0 ? '+' : ''}${formatCurrency(customer.balance)}
                    </td>
                </tr>
            `).join('');
            
            // Load supplier ledger
            const supplierLedgerBody = document.getElementById('supplier-ledger-body');
            supplierLedgerBody.innerHTML = suppliers.map(supplier => `
                <tr>
                    <td>${supplier.name}</td>
                    <td class="${supplier.balance > 0 ? 'text-danger' : 'text-success'}">
                        ${supplier.balance > 0 ? '+' : ''}${formatCurrency(supplier.balance)}
                    </td>
                </tr>
            `).join('');
        }

        // Reports Management Functions
        function generateSalesReport() {
            showToast('Sales report generated and downloaded', 'success');
        }

        function generateStockReport() {
            showToast('Stock report generated and downloaded', 'success');
        }

        function loadReportsData() {
            // Calculate report statistics
            const totalSales = sales.reduce((sum, sale) => sum + sale.grand_total, 0);
            const totalPurchases = purchases.reduce((sum, purchase) => sum + purchase.grand_total, 0);
            const totalProfit = totalSales - totalPurchases;
            const totalCustomerBalance = customers.reduce((sum, customer) => sum + customer.balance, 0);
            
            document.getElementById('total-sales-amount').textContent = formatCurrency(totalSales);
            document.getElementById('total-purchase-amount').textContent = formatCurrency(totalPurchases);
            document.getElementById('total-profit-amount').textContent = formatCurrency(totalProfit);
            document.getElementById('total-customer-balance').textContent = formatCurrency(totalCustomerBalance);
            
            // Load recent transactions
            const recentTransactionsBody = document.getElementById('recent-transactions-body');
            const allTransactions = [
                ...sales.map(s => ({ ...s, type: 'sale' })),
                ...purchases.map(p => ({ ...p, type: 'purchase' })),
                ...payments.map(p => ({ ...p, type: 'payment' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            
            recentTransactionsBody.innerHTML = allTransactions.map(transaction => {
                let description = '';
                let amount = 0;
                
                if (transaction.type === 'sale') {
                    description = `Sale to ${transaction.customer_name}`;
                    amount = transaction.grand_total;
                } else if (transaction.type === 'purchase') {
                    description = `Purchase from ${transaction.supplier_name}`;
                    amount = -transaction.grand_total;
                } else if (transaction.type === 'payment') {
                    description = `Payment from ${transaction.customer_name}`;
                    amount = transaction.amount;
                }
                
                return `
                    <tr>
                        <td>${new Date(transaction.date).toLocaleDateString()}</td>
                        <td>${transaction.type.toUpperCase()}</td>
                        <td>${description}</td>
                        <td class="${amount >= 0 ? 'text-success' : 'text-danger'}">
                            ${amount >= 0 ? '+' : ''}${formatCurrency(amount)}
                        </td>
                        <td>-</td>
                    </tr>
                `;
            }).join('');
        }

        // Initialize all modules when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            initializeAllData();
            setupEventListeners();
            setupAllEventListeners();
            setupKeyboardShortcuts();
            
            // Load all module data
            loadDashboardData();
            loadMedicinesData();
            loadCustomersData();
            loadSuppliersData();
            loadSalesData();
            loadPurchasesData();
            loadReturnsData();
            loadLedgerData();
            loadReportsData();
            loadReceiptsData();
            loadPaymentsData();
        });

        // Update module switching to load data when module is shown
        function showModule(moduleName) {
            document.querySelectorAll('.module-section').forEach(module => {
                module.classList.remove('active');
            });
            
            const moduleElement = document.getElementById(moduleName);
            if (moduleElement) {
                moduleElement.classList.add('active');
                
                // Load module-specific data when shown
                switch(moduleName) {
                    case 'suppliers':
                        loadSuppliersData();
                        break;
                    case 'sales':
                        loadSalesData();
                        break;
                    case 'purchases':
                        loadPurchasesData();
                        break;
                    case 'returns':
                        loadReturnsData();
                        break;
                    case 'ledgers':
                        loadLedgerData();
                        break;
                    case 'reports':
                        loadReportsData();
                        break;
                }
            }
            
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const navLink = document.querySelector(`[data-module="${moduleName}"]`);
            if (navLink) {
                navLink.classList.add('active');
            }
        }
    </script>
</body>
</html>
